rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== FONCTIONS DE VALIDATION =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isFriend(userId, friendId) {
      return isAuthenticated() && 
             (request.auth.uid == userId || request.auth.uid == friendId);
    }
    
    // Fonction optimis√©e pour v√©rifier si l'utilisateur peut voir les points
    function canViewUserPoints(userId) {
      return isAuthenticated() && 
             (request.auth.uid == userId || 
              // V√©rification d'amiti√© - sera g√©r√©e au niveau de l'application
              true);
    }
    
    // Fonction pour v√©rifier si deux utilisateurs sont amis
    function areFriends(userId1, userId2) {
      return isAuthenticated() && 
             (request.auth.uid == userId1 || request.auth.uid == userId2);
    }
    
    function isValidEmail(email) {
      return email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }
    
    function isValidDisplayName(name) {
      return name is string && name.size() > 0 && name.size() <= 50;
    }
    
    function isValidPseudo(pseudo) {
      return pseudo is string && pseudo.size() >= 3 && pseudo.size() <= 30;
    }
    
    function isValidEmoji(emoji) {
      return emoji in ['‚ù§Ô∏è', 'üëç', 'üòä', 'üéâ', 'üî•', 'üíØ', 'üåü', 'üíñ'];
    }
    
    function isValidRating(rating) {
      return rating is number && rating >= 1 && rating <= 5;
    }
    
    function isValidCoordinates(lat, lng) {
      return lat is number && lng is number && 
             lat >= -90 && lat <= 90 && 
             lng >= -180 && lng <= 180;
    }
    
    // ===== R√àGLES POUR LES PROFILS UTILISATEURS =====
    match /users/{userId} {
      // Lecture : soi-m√™me OU recherche pour ajouter des amis (par code) OU lecture des profils des amis
      allow read: if isOwner(userId) || 
                   (isAuthenticated() && 
                    (request.query.limit <= 1 || // Recherche par code
                     request.query.limit == null)); // Lecture directe des profils des amis
      
      // Cr√©ation : seulement soi-m√™me avec validation stricte
      allow create: if isOwner(userId) && 
                     request.resource.data.keys().hasAll(['uid', 'email', 'pseudo', 'displayName', 'code']) &&
                     request.resource.data.uid == userId &&
                     isValidEmail(request.resource.data.email) &&
                     isValidPseudo(request.resource.data.pseudo) &&
                     isValidDisplayName(request.resource.data.displayName) &&
                     request.resource.data.code is string &&
                     request.resource.data.code.size() == 5;
      
      // Modification : seulement soi-m√™me avec validation
      allow update: if isOwner(userId) && 
                     request.resource.data.uid == userId &&
                     (request.resource.data.email == resource.data.email || isValidEmail(request.resource.data.email)) &&
                     (request.resource.data.pseudo == resource.data.pseudo) && // Pseudo immuable
                     isValidDisplayName(request.resource.data.displayName) &&
                     request.resource.data.code == resource.data.code; // Code immuable
      
      // Suppression : seulement soi-m√™me
      allow delete: if isOwner(userId);
    }
    
    // ===== R√àGLES POUR LES LOVs (collection FCKS) =====
    match /fcks/{fckId} {
      // Lecture : soi-m√™me OU amis (pour les notifications)
      allow read: if isAuthenticated() && 
                   (request.auth.uid == resource.data.userId || 
                    // Pour les notifications, permettre la lecture des LOVs des amis
                    // La v√©rification d'amiti√© sera faite au niveau de l'application
                    true);
      
      // Cr√©ation : seulement soi-m√™me avec validation stricte
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     isValidCoordinates(request.resource.data.latitude, request.resource.data.longitude) &&
                     request.resource.data.emoji in ['aubergine', 'peche'] &&
                     request.resource.data.locationType in ['address', 'city'] &&
                     isValidRating(request.resource.data.rating) &&
                     request.resource.data.addressLabel is string &&
                     request.resource.data.addressLabel.size() > 0;
      
      // Modification : seulement le propri√©taire avec validation
      allow update: if isOwner(resource.data.userId) &&
                     (request.resource.data.userId == resource.data.userId) && // userId immuable
                     (request.resource.data.userEmail == resource.data.userEmail); // userEmail immuable
      
      // Suppression : seulement le propri√©taire
      allow delete: if isOwner(resource.data.userId);
      
      // ===== SOUS-COLLECTION R√âACTIONS =====
      match /reactions/{reactionId} {
        // Lecture : utilisateurs connect√©s (pour les notifications)
        allow read: if isAuthenticated();
        
        // Cr√©ation : seulement soi-m√™me
        allow create: if isAuthenticated() && 
                       request.resource.data.userId == request.auth.uid;
        
        // Suppression : seulement l'auteur de la r√©action
        allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
        
        // Pas de modification des r√©actions
        allow update: if false;
      }
    }
    
    // ===== R√àGLES POUR LES R√âACTIONS S√âCURIS√âES =====
    match /reactions/{reactionId} {
      // Lecture : seulement utilisateurs connect√©s
      allow read: if isAuthenticated();
      
      // Cr√©ation : seulement soi-m√™me avec validation
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.emoji is string &&
                     request.resource.data.lovId is string &&
                     request.resource.data.lovId.size() > 0;
      
      // Suppression : seulement l'auteur de la r√©action
      allow delete: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Pas de modification des r√©actions
      allow update: if false;
    }
    
    // ===== R√àGLES POUR LES AMITI√âS S√âCURIS√âES =====
    match /friendships/{friendshipId} {
      // Lecture : utilisateurs connect√©s peuvent lire toutes les amiti√©s
      // (n√©cessaire pour l'affichage de la liste des amis)
      allow read: if isAuthenticated();
      
      // Cr√©ation : seulement soi-m√™me avec validation de base
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.friendId is string &&
                     request.resource.data.friendId != request.auth.uid;
      
      // Modification : seulement les utilisateurs impliqu√©s
      allow update: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || 
                      request.auth.uid == resource.data.friendId);
      
      // Suppression : seulement les utilisateurs impliqu√©s
      allow delete: if isAuthenticated() && 
                     (request.auth.uid == resource.data.userId || 
                      request.auth.uid == resource.data.friendId);
    }
    
    // ===== R√àGLE PAR D√âFAUT =====
    // Toutes les autres collections sont refus√©es par d√©faut
    match /{document=**} {
      allow read, write: if false;
    }
  }
}