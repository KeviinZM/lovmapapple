rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===== FONCTIONS DE VALIDATION =====
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isFriend(userId, friendId) {
      return isAuthenticated() && 
             (request.auth.uid == userId || request.auth.uid == friendId);
    }
    
    // Nouvelle fonction pour vÃ©rifier si l'utilisateur peut voir les points d'un autre utilisateur
    function canViewUserPoints(userId) {
      return isAuthenticated() && 
             (request.auth.uid == userId || 
              // VÃ©rifier si une amitiÃ© existe entre l'utilisateur actuel et l'utilisateur cible
              // Cette vÃ©rification se fait au niveau de l'application, pas dans les rÃ¨gles
              true);
    }
    
    function isValidEmail(email) {
      return email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }
    
    function isValidDisplayName(name) {
      return name is string && name.size() > 0 && name.size() <= 50;
    }
    
    function isValidEmoji(emoji) {
      return emoji in ['â¤ï¸', 'ðŸ‘', 'ðŸ˜Š', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ’¯', 'ðŸŒŸ', 'ðŸ’–'];
    }
    
    // ===== RÃˆGLES POUR LES PROFILS UTILISATEURS =====
    match /users/{userId} {
      // Lecture : soi-mÃªme OU recherche pour ajouter des amis (par code)
      allow read: if isOwner(userId) || 
                   (isAuthenticated() && 
                    request.query.limit <= 1);
      
      // CrÃ©ation : seulement soi-mÃªme avec validation
      allow create: if isOwner(userId) && 
                     request.resource.data.keys().hasAll(['uid', 'email', 'displayName']) &&
                     request.resource.data.uid == userId &&
                     isValidEmail(request.resource.data.email) &&
                     isValidDisplayName(request.resource.data.displayName) &&
                     (request.resource.data.code is string || request.resource.data.code == null) &&
                     (request.resource.data.hasSetInitialDisplayName is bool || request.resource.data.hasSetInitialDisplayName == null);
      
      // Modification : seulement soi-mÃªme avec validation
      allow update: if isOwner(userId) && 
                     request.resource.data.uid == userId &&
                     (request.resource.data.email == resource.data.email || isValidEmail(request.resource.data.email)) &&
                     isValidDisplayName(request.resource.data.displayName) &&
                     (request.resource.data.code is string || request.resource.data.code == null) &&
                     (request.resource.data.hasSetInitialDisplayName is bool || request.resource.data.hasSetInitialDisplayName == null);
      
      // Suppression : seulement soi-mÃªme
      allow delete: if isOwner(userId);
    }
    
    // ===== RÃˆGLES POUR LES LOVs (FCKs) =====
    match /fcks/{fckId} {
      // Lecture : seulement soi-mÃªme OU amis (nouvelle rÃ¨gle de sÃ©curitÃ©)
      allow read: if canViewUserPoints(resource.data.userId);
      
      // CrÃ©ation : seulement soi-mÃªme avec validation simplifiÃ©e
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.latitude is number &&
                     request.resource.data.longitude is number;
      
      // Modification : seulement le propriÃ©taire
      allow update: if isOwner(resource.data.userId);
      
      // Suppression : seulement le propriÃ©taire
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ===== RÃˆGLES POUR LES RÃ‰ACTIONS SÃ‰CURISÃ‰ES =====
    match /reactions/{reactionId} {
      // Lecture : seulement utilisateurs connectÃ©s
      allow read: if isAuthenticated();
      
      // CrÃ©ation : seulement soi-mÃªme avec validation simplifiÃ©e
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.emoji is string &&
                     request.resource.data.lovId is string;
      
      // Suppression : seulement l'auteur de la rÃ©action
      allow delete: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      // Pas de modification des rÃ©actions
      allow update: if false;
    }
    
    // ===== RÃˆGLES POUR LES AMITIÃ‰S SÃ‰CURISÃ‰ES =====
    match /friendships/{friendshipId} {
      // Lecture : utilisateurs connectÃ©s peuvent lire les amitiÃ©s oÃ¹ ils sont impliquÃ©s
      // OU lire toutes les amitiÃ©s pour la gestion des amis (nÃ©cessaire pour l'app)
      allow read: if isAuthenticated();
      
      // CrÃ©ation : seulement soi-mÃªme avec validation
      allow create: if isAuthenticated() && 
                     request.resource.data.userId == request.auth.uid &&
                     request.resource.data.keys().hasAll(['userId', 'friendId', 'status']) &&
                     request.resource.data.status in ['pending', 'accepted', 'rejected'];
      
      // Modification : seulement les parties impliquÃ©es
      allow update: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.friendId == request.auth.uid);
      
      // Suppression : seulement les parties impliquÃ©es (propriÃ©taire OU ami)
      allow delete: if isAuthenticated() && 
                     (resource.data.userId == request.auth.uid || 
                      resource.data.friendId == request.auth.uid);
    }
    
    // ===== RÃˆGLES POUR LES AMIS (SOUS-COLLECTION) =====
    match /users/{userId}/friends/{friendId} {
      // Lecture/Ã©criture : seulement le propriÃ©taire
      allow read, write: if isOwner(userId);
    }
    
    // ===== RÃˆGLES POUR LES STATISTIQUES SÃ‰CURISÃ‰ES =====
    match /stats/{statId} {
      // Lecture/Ã©criture : seulement le propriÃ©taire
      allow read, write: if isOwner(resource.data.userId);
    }
    
    // ===== RÃˆGLES POUR LES NOTIFICATIONS SÃ‰CURISÃ‰ES =====
    match /notifications/{notificationId} {
      // Lecture : seulement le destinataire
      allow read: if isAuthenticated() && 
                   resource.data.recipientId == request.auth.uid;
      
      // CrÃ©ation : seulement pour des utilisateurs connectÃ©s
      allow create: if isAuthenticated() && 
                     request.resource.data.recipientId is string &&
                     request.resource.data.recipientId.size() > 0;
      
      // Modification/suppression : seulement le destinataire
      allow update, delete: if isAuthenticated() && 
                             resource.data.recipientId == request.auth.uid;
    }
    
    // ===== RÃˆGLES DE SÃ‰CURITÃ‰ GÃ‰NÃ‰RALES =====
    
    // Permettre la crÃ©ation de nouvelles collections (nÃ©cessaire pour friendships)
    match /{document=**} {
      allow read, write: if false;
    }
  }
}